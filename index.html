<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market-CR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>

<!-- NAVBAR con selector de categorÃ­a -->
<nav class="navbar navbar-expand-lg navbar-light bg-info px-4">
  <a class="navbar-brand fw-bold" href="#">Market-CR</a>
  <div class="ms-auto d-flex align-items-center">
    <select id="category-select" class="form-select w-auto me-2">
      <option value="all">Todas las categorÃ­as</option>
    </select>
    <input id="search-input" class="form-control me-2" type="search" placeholder="Buscar productos..." />
    <button class="btn btn-outline-dark" type="button" disabled>Buscar</button>
  </div>
  <button class="btn btn-outline-light position-relative ms-3" data-bs-toggle="modal" data-bs-target="#cartModal">
    ðŸ›’ Carrito
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">0</span>
  </button>
</nav>

<!-- Carrusel -->
<div id="carouselExample" class="carousel slide my-4 container" data-bs-ride="carousel">
  <div class="carousel-inner rounded" id="carousel-inner"></div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>

<!-- Productos -->
<div class="container">
  <h2 class="mb-4">Productos</h2>
  <div class="row row-cols-1 row-cols-md-3 g-4" id="product-list"></div>
</div>

<!-- Modal carrito -->
<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Carrito de compras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group mb-3" id="cart-items"></ul>
        <h5 class="text-end">Total: â‚¡<span id="cart-total">0</span></h5>
        <div class="text-end mt-3">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#checkoutModal">Confirmar compra</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal checkout -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="checkout-form">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar compra</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" required />
          </div>
          <div class="mb-3">
            <label class="form-label">TelÃ©fono</label>
            <input type="tel" class="form-control" id="telefono" pattern="[0-9]{8}" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Enviar pedido</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer class="bg-dark text-white text-center mt-5 p-4">
  <p class="mb-0">Â© 2025 Market-CR</p>
</footer>

<style>
  .carousel-inner {
    text-align: center;
  }
  .carousel-inner img {
    max-height: 300px;
    width: auto;
    display: inline-block;
  }
  .form-select {
    max-width: 200px;
  }
</style>

<!-- SDK EmailJS v3 -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("EYmvLTlkQZL9_r4zS"); // tu PUBLIC KEY
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
let products = [
  { name: "Guantes de boxeo...", images: 3, available: 5, category: "Deportes" },
  { name: "Manga refrescantes para brazos", images: 3, available: 10, category: "Deportes" },
  { name: "Masajeador de cuello de soporte cervical", images: 3, available: 7, category: "Salud" },
  { name: "Hombrera de compresiÃ³n", images: 3, available: 6, category: "Ortopedia" },
  { name: "MuÃ±equera para el sÃ­ndrome del tÃºnel carpiano", images: 3, available: 8, category: "Ortopedia" },
  { name: "Guantes de boxeo premium", images: 1, available: 4, category: "Deportes" },
  { name: "Vendaje de compresiÃ³n ajustable para tobillo", images: 3, available: 9, category: "Ortopedia" },
  { name: "Codera ajustable", images: 3, available: 5, category: "Ortopedia" },
  { name: "Rodillera de compresiÃ³n ajustable con funda antideslizante", images: 2, available: 6, category: "Ortopedia" },
  { name: "MuÃ±equera de compresiÃ³n ajustable de poliÃ©ster transpirable", images: 2, available: 7, category: "Ortopedia" },
  { name: "MuÃ±equera ergonÃ³mica negra de fibra", images: 3, available: 5, category: "Ortopedia" }
];

const carouselContainer = document.getElementById("carousel-inner");
const productList = document.getElementById("product-list");
const categorySelect = document.getElementById("category-select");
const searchInput = document.getElementById("search-input");
const cartItems = document.getElementById("cart-items");
const cartTotal = document.getElementById("cart-total");
const cartCount = document.getElementById("cart-count");

let cart = [];

function populateCategories() {
  const cats = [...new Set(products.map(p => p.category))].sort();
  cats.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    categorySelect.append(o);
  });
}

function renderCarousel() {
  carouselContainer.innerHTML = "";
  let first = true;
  products.forEach(p => {
    const folder = encodeURIComponent(p.name);
    for (let i = 1; i <= p.images; i++) {
      const div = document.createElement("div");
      div.className = first ? 'carousel-item active' : 'carousel-item';
      first = false;
      div.innerHTML = `<img src="img/${folder}/${i}.png" class="d-block w-100" alt="${p.name}">`;
      carouselContainer.append(div);
    }
  });
}

function renderProducts() {
  let list = [...products];
  const cat = categorySelect.value;
  const term = searchInput.value.trim().toLowerCase();

  if (cat !== 'all') list = list.filter(p => p.category === cat);
  if (term) list = list.filter(p => p.name.toLowerCase().includes(term));

  productList.innerHTML = list.length
    ? list.map(p => {
      const folder = encodeURIComponent(p.name);
      const disabled = p.available > 0 ? `<button class="btn btn-success w-100" onclick='addToCart("${p.name}")'>Agregar</button>` : `<button class="btn btn-secondary w-100" disabled>Agotado</button>`;
      return `
        <div class="col">
          <div class="card h-100">
            <img src="img/${folder}/1.png" class="card-img-top" alt="${p.name}">
            <div class="card-body">
              <h5 class="card-title">${p.name}</h5>
              <p class="text-muted small">â‚¡${(p.price||0).toLocaleString()}</p>
              <p class="text-muted small">CategorÃ­a: ${p.category}</p>
              <p class="text-muted small">Disponible: ${p.available}</p>
              ${disabled}
            </div>
          </div>
        </div>`;
    }).join('')
    : `<div class="col"><p class="text-center">No se encontraron productos.</p></div>`;
}

function addToCart(name) {
  const p = products.find(x => x.name === name);
  if (!p || p.available < 1) return alert("Producto agotado");
  p.available--;
  const c = cart.find(x => x.name===name);
  c ? c.quantity++ : cart.push({ ...p, quantity: 1 });
  updateCart();
}

function removeFromCart(name) {
  cart = cart.filter(x => {
    if (x.name === name) {
      const p = products.find(y => y.name === name);
      p.available += x.quantity;
      return false;
    }
    return true;
  });
  updateCart();
}

function updateCart() {
  cartItems.innerHTML = cart.map(c => `
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div><h6>${c.name}</h6><small class="text-muted">Cant: ${c.quantity}</small></div>
      <div>â‚¡${(c.quantity*c.price).toLocaleString()} <button class="btn btn-sm btn-danger ms-2" onclick="removeFromCart('${c.name}')">âœ•</button></div>
    </li>
  `).join('');
  const total = cart.reduce((s,c)=>s+c.quantity*c.price,0);
  cartTotal.textContent = total.toLocaleString();
  cartCount.textContent = cart.reduce((s,c)=>s+c.quantity,0);
  renderProducts();
}

document.getElementById("checkout-form").addEventListener("submit", e => {
  e.preventDefault();
  const nombre = document.getElementById("nombre").value.trim();
  const telefono = document.getElementById("telefono").value.trim();
  if (!nombre||!telefono) return alert("Completa todos los campos");

  const productos = cart.map(c => `${c.name} x${c.quantity}`).join(", ");
  const total = cart.reduce((s,c)=>s+c.quantity*c.price,0);

  emailjs.send('service_7u7388h', 'template_ryisoem', {
    nombre, telefono, productos, total: `â‚¡${total.toLocaleString()}`
  })
  .then(() => {
    alert("Â¡Pedido enviado!");
    cart = [];
    updateCart();
    document.getElementById("checkout-form").reset();
    bootstrap.Modal.getInstance(document.getElementById("checkoutModal")).hide();
  })
  .catch(err => {
    console.error(err);
    alert("Error al enviar pedido.");
  });
});

categorySelect.addEventListener("change", renderProducts);
searchInput.addEventListener("input", renderProducts);

(async function init() {
  await loadPricesFromExcel?.();
  populateCategories();
  renderCarousel();
  renderProducts();
})();
</script>

</body>
</html>
